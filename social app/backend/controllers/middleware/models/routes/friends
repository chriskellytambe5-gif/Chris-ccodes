import express from "express";
import FriendRequest from "../models/FriendRequest.js";
import User from "../models/User.js";
import { auth } from "../middleware/auth.js";

const router = express.Router();

router.post("/request/:toId", auth, async (req, res) => {
  const toId = req.params.toId;
  if (String(toId) === String(req.user._id)) return res.status(400).json({ message: "Cannot friend yourself" });

  const existing = await FriendRequest.findOne({ from: req.user._id, to: toId, status: "pending" });
  if (existing) return res.status(400).json({ message: "Already sent" });

  const fr = new FriendRequest({ from: req.user._id, to: toId });
  await fr.save();
  res.json({ message: "Request sent", fr });
});

router.get("/requests/incoming", auth, async (req, res) => {
  const list = await FriendRequest.find({ to: req.user._id, status: "pending" }).populate("from", "name email avatarUrl");
  res.json(list);
});

router.get("/requests/outgoing", auth, async (req, res) => {
  const list = await FriendRequest.find({ from: req.user._id, status: "pending" }).populate("to", "name email avatarUrl");
  res.json(list);
});

router.post("/request/:id/accept", auth, async (req, res) => {
  const fr = await FriendRequest.findById(req.params.id);
  if (!fr || String(fr.to) !== String(req.user._id)) return res.status(404).json({ message: "Not found" });

  fr.status = "accepted";
  await fr.save();

  await User.findByIdAndUpdate(fr.from, { $addToSet: { friends: fr.to } });
  await User.findByIdAndUpdate(fr.to, { $addToSet: { friends: fr.from } });

  res.json({ message: "Accepted" });
});

router.post("/request/:id/decline", auth, async (req, res) => {
  const fr = await FriendRequest.findById(req.params.id);
  if (!fr || String(fr.to) !== String(req.user._id)) return res.status(404).json({ message: "Not found" });
  fr.status = "declined";
  await fr.save();
  res.json({ message: "Declined" });
});

router.get("/me", auth, async (req, res) => {
  const me = await User.findById(req.user._id).populate("friends", "name email avatarUrl");
  res.json(me.friends || []);
});

export default router;